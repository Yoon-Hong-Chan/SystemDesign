# 8. URL 단축기 설계
- 고전적인 시스템 설계 문제 중 하나, tiny url 같은 URL 단축기 설계 문제

## 8.1 문제 이해 및 설계 범위 확정
- 기본적 기능은 아래와 같음
  - URL 단축: 주어진 긴 URL을 훨씬 짧게 줄임
  - URL 리디렉션(redirection): 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내
  - 높은 가용성과 규모 확장성, 그리고 장애 감내 요구
- 개략적 추정
  - 쓰기 연산: 매일 1억 개의 단축 URL 생성
  - 초당 쓰기 연산: 1억(100million)/24/3600=1160
  - 읽기 연산: 읽기 연산과 쓰기 연산 비율은 10:1이라고 하자. 읽기 연산은 초당 11,600회 발생
  - URL 단축 서비스를 10년간 운영한다고 가정하면 1억 x 365 x 10 = 3650억개의 레코드를 보관
  - 축약 전 URL의 평균 길이는 100이라고 하자
  - 10년 동안 필요한 저장 용량은 3650억 x 100byte = 36.5TB

## 8.2 개략적 설계안 제시 및 동의 구하기
- API 엔드포인트, URL 리디렉션, URL 단출 플로로 살펴봄

##### API 엔드포인트
- 클라이언트는 서버가 제공하는 API 엔드포인트를 통해 서버와 통신 -> REST 스타일로 설계
- URL 단축기는 기본적으로 2개의 엔드포인트를 필요
  - URL 단축용 엔드포인트: 새 단축 UR을 생성, 클라이언트에서 POST 요청
    - POST /api/v1/data/shorten
      - 인자: {longUrl: longURLstring}
      - 반환: 단축 URL
  - URL 리디렉션용 엔드포인트: 단축 URL에 대해서 HTTP 요청이 오면 원래 URL로 보내주기 위한 용도의 엔드포인트
    - GET /api/v1/shortUrl
      - 반환: HTTP 리디렉션 목적지가 될 원래 URL

##### URL 리디렉션
![img.png](img.png)
- 단축 URL을 받은 서버는 그 URL을 원래 URL로 바꾸어서 301 응답의 Location 헤더에 넣어서 반환\
![img_1.png](img_1.png)
- 유의할 것은 301 응답과 302 응답의 차이
  - 301 Permanently Moved
    - 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전
    - 영구적 이전이므로, 브라우저는 이 응답을 캐시 처리함 -> 추후 같은 요청에 브라우저에서 캐시된 원래 URL로 요청을 보냄
  - 302 Found
    - 일시적으로 Location 헤더가 지정하는 URL에 의해 처리되어야 하는 응답
    - 301과는 다르게 캐시처리되지 않고 언제나 같은 플로우로 작동
- 두 방법은 각기 다른 장단점 존재
  - 서버 부하를 줄이는 방향: 301 활용
  - 트래픽 분석이 중요: 302 활용 -> 클릭 발생률이나 발생 위치 추적 도움
- URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블 사용
  - 해시 테이블에 <단축 URL, 원래 URL>의 쌍을 저장
    - 원래 URL = hashTable.get(단축 URL)
    - 301 또는 302 응답 Location 헤더에 원래 URL을 넣은 후 전송

##### URL 단축
![img_2.png](img_2.png)
- 긴 URL을 해시 값으로 대응시킬 해시 함수 fx를 찾는 것은 중요한 일이므로 다음 요구 사항 만족
  - 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야함
  - 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원 가능

## 8.3 상세 설계
- 데이터 모델, 해시 함수, URL 단축 및 리디렉션 구체적인 설계안 살펴봄

##### 데이터 모델
- 모든 것을 해시 테이블로 설계 -> 메모리는 유한하기에 실제 시스템에 활용 곤란
- 더 나은 방법은 <단축 URL, 원래 URL>의 순서 쌍으로 RDB에 저장\
![img_3.png](img_3.png)

##### 해시 함수
- 원래 URL을 단축 URL로 변환하는데 사용, 편의상 단축 URL을 hashValue로 지칭
- 해시 값 길이
  - hashValue는 [0-9,a-z,A-Z]의 문자들로 구성 -> 사용 가능한 문자는 62개(10 + 26 +26)
  - hashValue의 길이를 정하기 위해서는 62의 n승 >= 3650억 인 n의 최솟값을 찾아야 함(3650억의 URL 생성)\
![img_4.png](img_4.png)
  - n이 7개면 3.5조 개의 URL을 만들수 있음 -> hashValue 길이는 7개로 함
- 해시 후 충돌 해소