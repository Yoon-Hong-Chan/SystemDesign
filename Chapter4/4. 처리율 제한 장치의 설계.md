# 4. 처리율 제한 장치의 설계
- 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치
  - HTTP를 예로 들면 클라이언트의 요청 횟수를 제한
  - 요청 횟수가 제한 임계치(threshhold)를 넘어서면 중단 처리
- 처리율 제한 장치를 두면 이점
  - DOS공격에 의한 자원 고갈을 방지
  - 비용 절감 -> 불필요한 요청 처리를 위한 서버를 두지 않아도 됨
  - 서버 과부하를 막음

## 4.1 문제를 이해 및 설계 범위 확정
- 처리율 제한 장치를 구현하는데 있어 여러가지 알고리즘 사용 가능 -> 각각 장단점 존재
- 인터뷰를 통해 하기와 같은 조건 존재
  - 설정된 처리율을 초과하는 요청은 정확하게 제한
  - 낮은 응답시간: 처리율 제한 장치는 HTTP 응답시간에 나쁜 영향을 주면 안됨
  - 가능한 적은 메모리 활용해야 함
  - 분산형 처리율 제한: 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유
  - 예외 처리: 요청이 제한되었을 때는 그 사실을 사용자에게 분명하게 제공
  - 높은 결함 감내성: 
## 4.2 개략적 설계안 제시 및 동의 구하기
#### 처리율 제한 장치는 어디에 둘 것인가?
- 클라이언트에 둔다면?
  - 클라이언트는 위변조가 가능하기에 안정적으로 제한 걸기가 어려움
- 서버에 둔다면?
  - 서버에 두는 방법\
![img.png](img.png)
  - 미들웨어로 만들어 서버로 가는 요청 통제하는 방법 -> 요청이 많을 시 status 429 내려지는 시나리오\
![img_1.png](img_1.png)\
![img_2.png](img_2.png)
  - cloud MicroService와 같은 경우, 보통 API gateway라 불리는 컴포넌트에 구현
- 처리율 제한 장치를 설계할 때 위치를 정하는 것은 중요한 부분
- 위치에 대한 정답은 없음 -> 회사 기술스택, 우선 순위등으로 달라질 수 있음

#### 처리율 제한 알고리즘
- 처리율 제한 알고리즘은 여러가지이며, 각기 장단점을 갖고 있음
  - 토큰 버킷
    - 폭 넓게 이용되고 있는 알고리즘
    - 동작 원리
      - 최대 N개의 토큰만 채워지고, 매초 M개씩 채워짐
      - 사용 시 토큰은 소비되고, 다른 요청에 대해 토큰이 없을 시 요청은 버려짐
      - 알고리즘 인자
        - 버킷 크기: 버킷에 담을 수 있는 토큰의 최대 개수
        - 토큰 공급률: 초당 몇 개의 토큰이 버킷에 공급
    - 장점
      - 구현이 쉬움
      - 메모리 사용 측면에서도 효율적
      - 짧은 시간에 집중되는 트래픽도 처리 가능, 버킷에 남은 토큰이 있기만 하면 요청은 시스템에게 전달
    - 단점
      - 버킷 크기와 토큰 공급률을 적절히 튜닝하기가 까다로움\
![img_3.png](img_3.png)\
![img_4.png](img_4.png)\
  - 누출 버킷
    - 요청 처리율이 고정되어 있는다는 점이 토큰 버킷과 다름, FIFO 큐로 구현됨
    - 동작 원리
      - 요청이 오면 큐를 확인하고, 큐가 빈자리가 있으면 큐에 요청 추가
      - 큐가 가득차 있는 경우에는 새 요청을 버림
      - 지정된 시간 마다 큐에서 요청을 꺼내어 처리
    - 파라미터
      - 버킷 크기: 큐 사이즈와 같은 값
      - 처리율: 지정된 시간당 몇 개의 항목을 처리할지 지정하는 값, 보통 초 단위로 표현
    - 장점
      - 큐의 크기가 제한되어 있어 메모리 사용량 측면에서 효율적
      - 고정된 처리율을 갖고 있기 때문에 안정적 출력이 필요한 경우 적합
    - 단점
      - 단시간 많은 트래픽이 몰리는 경우 큐에는 오래된 요청들이 쌓여 최신 요청들이 버려짐
      - 두개의 인자를 가지고 올바르게 튜닝이 어려움\
![img_5.png](img_5.png)
  - 고정 윈도 카운터
    - 동작 원리
      - 타임라인을 고정된 간격의 윈도로 나누고, 각 윈도마다 카운터를 붙임
      - 요청이 접수될 때마다 이 카운터의 값이 1씩 증가
      - 카운터가 임계치에 도달하면 새로운 요청은 새 윈도가 열릴 때까지 버려짐
    - 윈도의 경계 부근에 순간적으로 많은 트래픽이 집중될 경우 할당된 양보다 많은 요청 처리될 이슈 존재
      - 분에 5개가 임계치이고 분 단위로 갯수 초기화
      - 아래와 같이 윈도 경계 부근에 더 많은 양에 트래픽이 들어올 수 있음\
![img_6.png](img_6.png)
    - 장점
      - 메모리 효율이 좋음
      - 이해하기가 쉬움
      - 특정한 트래픽 패턴을 처리하기에 적합함
    - 단점
      - 윈도 경계 부근에 일시적으로 많은 트래픽이 몰리면 경우 발생
  - 이동 윈도 로그
    - 고정 윈도 
  - 이동 윈도 카운터